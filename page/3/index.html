<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8">
<title>joshua poehls | silent thoughts</title>

<link rel="canonical" href="http://joshua.poehls.me/">
<link href="/feed.xml" rel="alternate" type="application/atom+xml" title="joshua poehls | silent thoughts">
<meta name="generator" content="Hugo 0.59.0" />


<link rel="stylesheet" href="/normalize.css">
<link rel="stylesheet" href="/skeleton.css">
<link rel="stylesheet" href="/styles.css">


<link href='///fonts.googleapis.com/css?family=Merriweather' rel='stylesheet' type='text/css'>
<link href='///fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<link href='///fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>


<meta name="viewport" content="width=device-width, initial-scale=1">


<link rel="apple-touch-icon" href="/touch-icon-iphone.png" /> 
<link rel="apple-touch-icon" sizes="76x76" href="/touch-icon-ipad.png" /> 
<link rel="apple-touch-icon" sizes="120x120" href="/touch-icon-iphone-retina.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/touch-icon-ipad-retina.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/touch-icon-iphone-retinahd.png">

</head>
<body lang="en-US">

<header id="masthead">
	<div class="container">
		<div class="row">
			<div class="twelve columns">
				<h1>
					<small>I am</small>
					<a href="/">Joshua Poehls</a>.
					<small class="contact-link"><a href="/contact">Say hello</a></small>
					<small class="archives-link"><a href="/archives">Archives</a></small>
					<span class="aka">(not so) silent thoughts</span>
				</h1>
			</div>
		</div>
	</div>
</header>



<div class="container">

	<section id="posts">
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/2014/09/hello-world/">Hello World</a>
            
        </h1>
        <p>
            <time datetime="2014-09-25 09:58:59 -0500 CDT" pubdate="pubdate">Thu, Sep 25, 2014</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/2014/09/hello-world/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/2014/09/hello-world/</span>
            </a>
        </p>
    </header>

    <p>Welcome to my new blog! <sup class="footnote-ref" id="fnref:fn1"><a href="#fn:fn1">1</a></sup> All of my blogging in the past has been in the form of longer articles, mostly technology related, and mostly trying to teach a tip or trick.</p>

<p>I&rsquo;m taking a different approach this time. I&rsquo;ll be posting more random thoughts.
Sharing articles I find interesting. Overall I expect this to feel more like reading my Facebook wall and that&rsquo;s what I&rsquo;m going for. <sup class="footnote-ref" id="fnref:fn2"><a href="#fn:fn2">2</a></sup></p>

<p>Here goes nothing!</p>

<table border="0" width="100%" style="font-size: 1.5em" class="noborder">
<tr>
<td>Hello World!</td>
<td style="text-align: center;">Hallo Welt!</td>
<td style="text-align: right; direction: rtl;">שלום עולם</td>
</tr>
</table>
<div class="footnotes">

<hr />

<ol>
<li id="fn:fn1">This is no longer the first post as I&rsquo;ve started migrating older content from my blog at <code>zduck.com</code>.
 <a class="footnote-return" href="#fnref:fn1">↩</a></li>
<li id="fn:fn2">This is my plan to take control of my public content. I&rsquo;ll still share on Facebook and Twitter, but I want to own the canonical version.
 <a class="footnote-return" href="#fnref:fn2">↩</a></li>
</ol>
</div>


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/2014/04/go-101-string-or-byte-slice/">Go 101: String or Byte Slice?</a>
            
        </h1>
        <p>
            <time datetime="2014-04-16 09:58:59 -0500 CDT" pubdate="pubdate">Wed, Apr 16, 2014</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/2014/04/go-101-string-or-byte-slice/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/2014/04/go-101-string-or-byte-slice/</span>
            </a>
        </p>
    </header>

    

<p>One of the first things you&rsquo;ll notice in Go is that two different types are commonly used for representing text. <code>string</code> and <code>[]byte</code>. A quick example is the <a href="http://golang.org/pkg/regexp/#Regexp.FindAll">regexp package</a> which has functions for both <code>string</code> and <code>[]byte</code>.</p>

<h2 id="what-is-the-difference">What is the difference?</h2>

<p><code>string</code> is immutable and <code>[]byte</code> is mutable. Both can contain arbitrary bytes.</p>

<p>The name &ldquo;string&rdquo; implies unicode text but this is not enforced. Operating on <code>string</code> is like operating on <code>[]byte</code>. You are working with bytes not characters.</p>

<p>They are nearly identical and differ only in mutability. The <a href="http://golang.org/pkg/strings/"><code>strings</code></a> and <a href="http://golang.org/pkg/bytes/"><code>bytes</code></a> packages are nearly identical apart from the type that they use.</p>

<blockquote>
<p><strong>Q:</strong> If strings are just arbitrary bytes, then how do you work with characters?</p>

<p><strong>A:</strong> What you are thinking of as a character, Go calls a <a href="http://golang.org/ref/spec#Rune_literals">rune</a>. One way to iterate the characters in a string is to use the <code>for...range</code> loop. Range will parse the string as UTF-8 and iterate the runes. Read <a href="http://golang.org/doc/effective_go.html#for">the <code>for</code> loop</a> section of Effective Go for more information.</p>
</blockquote>

<h2 id="when-to-use-string">When to use <code>string</code>?</h2>

<p>Ask not when to use <code>string</code> but rather, when to use <code>[]byte</code>. Always start with <code>string</code> and switch to <code>[]byte</code> when justified.</p>

<h2 id="when-to-use-byte">When to use <code>[]byte</code>?</h2>

<p>Use <code>[]byte</code> when you need to make many changes to a string. Since <code>string</code> is immutable, any change will allocate a new <code>string</code>. You can get better performance by using <code>[]byte</code> and avoiding the allocations.</p>

<blockquote>
<p>C# perspective: <code>[]byte</code> is to <a href="http://msdn.microsoft.com/en-us/library/system.text.stringbuilder(v=vs.110).aspx"><code>System.StringBuilder</code></a> as <code>string</code> is to <a href="http://msdn.microsoft.com/en-us/library/system.string(v=vs.110).aspx"><code>System.String</code></a> when it comes to performance.</p>
</blockquote>

<p>Even if your code isn&rsquo;t directly manipulating the string, you may want to use <code>[]byte</code> if you are using packages which require it so you can avoid the conversion.</p>

<p>Converting to and from <code>[]byte</code> is easy. Just remember that each conversion creates a copy of the value.</p>

<pre><code>s := &quot;some string&quot;
b := []byte(s) // convert string -&gt; []byte
s2 := string(b) // convert []byte -&gt; string
</code></pre>

<blockquote>
<p>Converting to/from <code>string</code> and <code>[]byte</code> copies the entire value. Using lots of type conversions in your code is typically a warning sign that you need to reevaluate the types you are using. You want to minimize conversions both for performance and clean code.</p>
</blockquote>

<h2 id="more-about-strings">More about strings</h2>

<p>The Go blog has posted in detail about <a href="http://blog.golang.org/strings">strings, bytes, runes, and characters in Go</a>. You should definitely read that post to fully understand the topic.</p>

<p><strong>Update:</strong> Thanks to <a href="https://twitter.com/mholt6">@mholt6</a> for reviewing the post and helping improve it!</p>


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/2014/04/go-101-methods-on-pointers-vs-values/">Go 101: Methods on Pointers vs. Values</a>
            
        </h1>
        <p>
            <time datetime="2014-04-14 09:58:59 -0500 CDT" pubdate="pubdate">Mon, Apr 14, 2014</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/2014/04/go-101-methods-on-pointers-vs-values/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/2014/04/go-101-methods-on-pointers-vs-values/</span>
            </a>
        </p>
    </header>

    <p>Methods can be declared on both pointers and values. The difference is subtle but important.</p>

<pre><code>type Person struct {
     age int
}

// Method's receiver is the value, `Person`.
func (p Person) Age() int {
     return p.age
}

// Method's receiver is a pointer, `*Person`.
func (p *Person) SetAge(age int) {
     p.age = age
}
</code></pre>

<blockquote>
<p>In reality, you&rsquo;d only define getter and setter functions like this if you needed to implement additional logic. In an example like this you&rsquo;d just make the <code>Age</code> field public.</p>
</blockquote>

<p>This is how you define getter and setter functions in Go. Notice that we defined the <code>Age()</code> function on the value but <code>SetAge()</code> on the pointer (i.e. <code>*Person</code>). This is important.</p>

<p><strong>Go always passes by value.</strong> Function parameters are  always passed by copying them as opposed to passing a reference. (<a href="http://golang.org/doc/faq#pass_by_value">Read more.</a>)</p>

<blockquote>
<p>Even pointers are technically passed by value. The memory address is copied, the value it points to is <em>not</em> copied.</p>
</blockquote>

<p>Here is the <em>wrong</em> way to define <code>SetAge</code>. Let&rsquo;s see what happens.</p>

<pre><code>func (p Person) SetAge(age int) {
     p.age = age
}

p := Person{}
p.SetAge(10)
fmt.Printf(&quot;Age: %v&quot;, p.Age()) // Age: 0
</code></pre>

<p><a href="http://play.golang.org/p/CJZfqBrAIC">&#9654; Run it.</a></p>

<p>Notice that the output is <code>0</code> instead of <code>10</code>? This is &lsquo;pass by value&rsquo; in action.</p>

<p>Calling <code>p.SetAge(10)</code> passes a copy of <code>p</code> to the <code>SetAge</code> function. <code>SetAge</code> sets the <code>age</code> property on the copy of <code>p</code> that it received which is discarded after the function returns.</p>

<p>Now let&rsquo;s do it the right way.</p>

<pre><code>func (p *Person) SetAge(age int) {
     p.age = age
}

p := Person{}
p.SetAge(10)
fmt.Printf(&quot;Age: %v&quot;, p.Age()) // Age: 10
</code></pre>

<p><a href="http://play.golang.org/p/BbIlSUQBCr">&#9654; Run it.</a></p>

<p>My rule of thumb is this: declare the method on the pointer unless your struct is such that you don&rsquo;t use pointers to it.</p>

<p>Two reasons:</p>

<ol>
<li>Performance. Calling a method on a pointer will almost always be faster than copying the value. There may be cases wear the copy is faster but those are edge case.</li>
<li>Consistency. It is common for at least one of your methods to need a pointer receiver and if any of the type&rsquo;s methods are on the pointer then they all should be. <em>This recommendation is direct from <a href="http://golang.org/doc/faq#methods_on_values_or_pointers">the FAQ</a>.</em></li>
</ol>

<p><a href="http://golang.org/doc/faq#methods_on_values_or_pointers">Read the FAQ</a> &ldquo;Should I define methods on values or pointers?&rdquo; for more insight.</p>

<p><strong>Update:</strong> Thanks to the fine folks on reddit for suggesting some improvements.<br />
<a href="http://www.reddit.com/r/golang/comments/23060m/go_101_methods_on_pointers_vs_values/">Join the discussion on reddit!</a></p>

<p><strong>Update 2:</strong> Here are <a href="https://github.com/golang/go/wiki/CodeReviewComments#receiver-type">even more rules of thumb</a> to help you choose whether to use a value or pointer receiver.</p>


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/2014/04/go-conventions-constructors-and-overloads/">Go 101: Constructors and Overloads</a>
            
        </h1>
        <p>
            <time datetime="2014-04-11 09:58:59 -0500 CDT" pubdate="pubdate">Fri, Apr 11, 2014</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/2014/04/go-conventions-constructors-and-overloads/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/2014/04/go-conventions-constructors-and-overloads/</span>
            </a>
        </p>
    </header>

    <p>Go doesn&rsquo;t have constructors in the traditional sense. The convention is to make the zero value useful whenever possible.</p>

<pre><code>type Person struct {
     Age int
}

// These are equivalent.
// `p1` and `p2` are initialized to the zero value of Person.
// Neither of these are nil.
var p1 Person // type Person
p2 := Person{} // type Person

// You could also use `new` to allocate which returns a pointer
p3 := new(Person) // type *Person
</code></pre>

<blockquote>
<p>It is most common to use the struct initializer. e.g. <code>p := Person{}</code> or <code>p := &amp;Person{}</code> if you need the pointer.</p>
</blockquote>

<p>Sometimes you want special initialization logic. If your type is named <code>Person</code> then the convention would be create a function named <code>NewPerson</code> that returns a pointer to an initialized <code>Person</code> type.</p>

<pre><code>func NewPerson(int age) *Person {
     p := Person{age}
     return &amp;p
}

myPerson := NewPerson(10) // type *Person
</code></pre>

<p>Multiple constructors can be implemented by having multiple initializer functions. Go doesn&rsquo;t support function overloads so you will need to name your functions intelligently.</p>

<pre><code>import &quot;time&quot;

func NewPersonAge(int age) *Person {
     p := Person{age}
     return &amp;p
}

func NewPersonBirthYear(int birthYear) *Person {
     p := Person{time.Now().Year() - birthYear}
     return &amp;p
}
</code></pre>

<p><a href="http://golang.org/doc/effective_go.html#composite_literals">Read more</a> in Effective Go.</p>

<p><strong>Update:</strong> Thanks to Joe Shaw for the comments! I&rsquo;ve updated the article with his suggestions.</p>


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/2014/go-and-package-versioning/">Go and Package Versioning</a>
            
        </h1>
        <p>
            <time datetime="2014-03-23 20:49:21 -0500 CDT" pubdate="pubdate">Sun, Mar 23, 2014</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/2014/go-and-package-versioning/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/2014/go-and-package-versioning/</span>
            </a>
        </p>
    </header>

    

<p><em>I&rsquo;ve been working with Go on personal projects for several months. During that time, Go&rsquo;s intended strategy for package management and versioning has largely eluded me. My understanding really started to come together over the past week which is why I wrote about my <a href="/2014/go-project-structure-and-dependencies">Go Project Structure</a> and now am writing about package versioning.</em></p>

<p><em>My goal with this post is to help others who, like myself, have had a hard time reconciling Go&rsquo;s approach to package dependencies and versioning with that of other languages.</em></p>

<h2 id="import-paths-and-go-get">Import Paths and <code>go get</code></h2>

<p>Other languages, particularly recent ones, tend to have a package manager that the community has adopted as defacto standard. Ruby has <a href="http://rubygems.org">gems</a>. Node has <a href="https://www.npmjs.org">npm</a>. .NET has <a href="http://www.nuget.org">NuGet</a>. Perl has <a href="http://www.cpan.org">CPAN</a>. Haskell has <a href="http://hackage.haskell.org">Hackage</a>. All of these have something in common; <strong>they are all a central package hosting repository.</strong></p>

<p><strong>Go&rsquo;s package manager is the <code>go get</code> command and it is completely decentralized.</strong></p>

<p>How does this work?</p>

<p>When you reference a package in your Go source code you use an import path that usually looks like a URL. e.g. <code>github.com/jpoehls/gophermail</code>. When you <code>go build</code> your code the Go tool uses this path to find the package in your <a href="http://golang.org/cmd/go/#hdr-GOPATH_environment_variable">GOPATH</a>. If it can&rsquo;t find the package the build fails. So how do you pull down the package?</p>

<ol>
<li>Manually. You can <code>git clone</code> the package into your GOPATH.</li>
<li>Use <a href="http://golang.org/cmd/go/#hdr-Download_and_install_packages_and_dependencies"><code>go get</code></a>. This is where the URL import path convention is leveraged. <code>go get</code> simply <a href="http://godoc.org/code.google.com/p/go/src/cmd/go#hdr-Remote_import_paths">treats the import path as a URL</a> and attempts to retrieve it via HTTP or HTTPS. It is smart enough to handle Git, Mercurial, Bazaar, and Subversion. Go has special support for common hosts like GitHub and Bitbucket, but you can use it with any host and even custom URLs.</li>
</ol>

<h2 id="finding-packages">Finding Packages</h2>

<p>As a <a href="http://babygopher.org">Baby Gopher</a> you may find it hard to locate packages that you need. e.g. &ldquo;What&rsquo;s a good image resizing package?&rdquo; You feel lost without a central repository to search.</p>

<p>Sites like <a href="http://godoc.org">GoDoc.org</a> <a href="http://go-search.org">Go-Search.org</a> fill the role of a central repository in this regard. They don&rsquo;t host the packages but they index all packages stored on various hosting sites. GitHub, Bitbucket, etc. They even include packages from your custom servers.</p>

<p>So to answer the question, &ldquo;what&rsquo;s a good image resizing package&rdquo;, all you have to do is a simple search.</p>

<ul>
<li><a href="http://godoc.org/?q=image+resize">http://godoc.org/?q=image+resize</a></li>
<li><a href="http://go-search.org/search?q=image+resize">http://go-search.org/search?q=image+resize</a></li>
</ul>

<blockquote>
<p>GoDoc.org was recently <a href="https://groups.google.com/d/topic/golang-nuts/_rbVuzl-OqA/discussion">adopted into the Go project</a> which is very, very cool.</p>
</blockquote>

<h2 id="package-versioning">Package Versioning</h2>

<p><code>go get</code> <em>is</em> the Go package manager. We&rsquo;ve seen how it works in a completely decentralized way and how package discovery still possible without a central package hosting repository.</p>

<p>Besides locating and downloading packages, the other big role of a package manager is handling multiple versions of the same package. Go takes the most minimal and pragmatic approach of any package manager. There is no such thing as multiple versions of a Go package.</p>

<p><code>go get</code> always pulls from the HEAD of the default branch in the repository. Always. This has two important implications.</p>

<blockquote>
<p>This isn&rsquo;t always true. If your repository has certain special branches then <code>go get</code> will pull from them instead. Specifically, if you have a <code>go1</code> branch and are running Go 1+ it will pull from that branch.</p>
</blockquote>

<ol>
<li>As a package author, you must adhere to the stable HEAD philosophy. Your default branch must always be the stable, released version of your package. You must do work in feature branches and only merge when ready to release.</li>
<li>New major versions of your package must have their own repository. Put simply, each major version of your package (following <a href="http://semver.org">semantic versioning</a>) would have its own repository and thus its own import path. e.g. <code>github.com/jpoehls/gophermail-v1</code> and <code>github.com/jpoehls/gophermail-v2</code>.</li>
</ol>

<p>It&rsquo;s that simple.</p>

<p>Another way to phrase this is that each import path must point to a stable API. Major version bumps are for backwards incompatible API changes and thus each major version is a distinct stable API. In the Go world this warrants a distinct import path and because <code>go get</code> ties import paths to VCS repositories, it means a distinct repository.</p>

<blockquote>
<p>This is exactly the explanation I wish was in the Go docs. They kind of dance around the idea but it isn&rsquo;t stated as clearly as it could be IMO. This is the epiphany that I needed to really understand how Go works.</p>
</blockquote>

<h2 id="version-2-0-new-repository">Version 2.0? New Repository.</h2>

<p>As someone building an application in Go, the above philosophy really doesn&rsquo;t have a downside. Every import path is a stable API. There are no version numbers to worry about. Awesome!</p>

<blockquote>
<p>I think this must have been the Go author&rsquo;s focus when designing <code>go get</code>. It is a solid and simple design for Go applications. I love it. It&rsquo;s only frustrating from the package authoring point of view, which I&rsquo;ll elaborate on below.</p>
</blockquote>

<p>The frustration lies with the authoring of packages. Putting different versions of your package in separate repositories is simply not the standard workflow. The standard flow is to maintain tags or branches for each version of your package.</p>

<p>As a package author, you think about your repository as the top level of your project and the ecosystem supports this (think GitHub). I&rsquo;ll use <a href="http://github.com/jpoehls/gophermail">gophermail</a> as an example. I can tag bugs with version numbers and organize them into release milestones, moving features from V1 to V2, etc. I might use GitHub Pages to serve a website for the project and host the documentation.</p>

<p>Go shatters this world view by forcing you to break your project into multiple repositories as soon as you want a version 2.0. The level of abstraction is simply moved from the branch level to the repository level and the ecosystem doesn&rsquo;t cater to this methodology.</p>

<p>The biggest hurdle is just understanding that this is the case. That this is how Go works.</p>

<p>The downside is all in code organization preference. The industry standard is to use tags and branches for marking multiple versions. Not separate repositories. <code>go get</code> thinks of branches as being used solely to target different versions of Go (i.e. the special <code>go1</code> branch) and, honestly, I think that&rsquo;s a pretty ugly hack on their part.</p>

<h2 id="multiple-versions-in-a-single-repository">Multiple Versions in a Single Repository</h2>

<p>There is a workaround that will allow you to keep multiple versions of your package in the same repository and use branches/tags for differentiating between them.</p>

<p><code>go get</code> supports custom URLs and you can use this to insert a version number into your package&rsquo;s import path. Granted, this is non-trivial. It means writing and hosting a proxy service that parses URL and proxies the requests to the applicable branch/tag of your repository.</p>

<p>Fortunately, someone has already done the hard work for us. <a href="http://gopkg.in">GoPkg.in</a> does exactly what I&rsquo;ve described.</p>

<p>I&rsquo;m taking advantage of this for my gophermail package. All it means is that instead of people using <code>github.com/jpoehls/gophermail</code> to import my package, they use <code>gopkg.in/jpoehls/gophermail.v0</code>. The <code>.v0</code> is because gophermail hasn&rsquo;t reached 1.0 yet. When I release 1.0 and declare a stable API, the import path will change to <code>gopkg.in/jpoehls/gophermail.v1</code>.</p>

<p><a href="http://gopkg.in">GoPkg.in</a> is a fantastic service and I encourage anyone with a Go package to use it. All you have to do is tell your users to use the <code>gopkg.in</code> import path for your package. If this gets wide enough attention, hopefully similar functionality will be adopted into <code>go get</code> itself.</p>

<blockquote>
<p>My dream is for <code>go get</code> to support a version number component in the import path. So <code>github.com/jpoehls/gophermail</code> would fetch the HEAD of the repository as it does today. <code>github.com/jpoehls/gophermail#v1</code> would fetch the <code>v1</code> branch or tag.</p>
</blockquote>


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/2014/go-project-structure-and-dependencies/">Go Project Structure and Dependencies</a>
            
        </h1>
        <p>
            <time datetime="2014-03-21 21:48:59 -0500 CDT" pubdate="pubdate">Fri, Mar 21, 2014</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/2014/go-project-structure-and-dependencies/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/2014/go-project-structure-and-dependencies/</span>
            </a>
        </p>
    </header>

    <p>Go is build around the concept of a <a href="http://golang.org/cmd/go/#hdr-GOPATH_environment_variable">GOPATH</a> which is a common workspace for most (or all) of your Go source code. This works well but sometimes you don&rsquo;t want the third party packages you depend on to be in your primary GOPATH. I can think of a few reasons for this:</p>

<p>&bull; You have multiple Go apps and each depend on different versions of the same third party package. Ideally these packages would use a versioned URL so that the import paths are different but this isn&rsquo;t always the case. (See <a href="http://gopkg.in">http://gopkg.in</a>, a great tool for package authors to use for providing versioned URLs.)</p>

<blockquote>
<p>If you want to know more about how package versioning works in Go, you should read my other post: <a href="{{site.url}}/2014/go-and-package-versioning">Go and Package Versioning</a></p>
</blockquote>

<p>&bull; You want to commit your third party packages as part of your application&rsquo;s code so that everything needed for a build is in one place. This guarantees that your app will always build regardless of the state of the third party repo and elminates a lot of headaches when working with a build server or multiple developers.</p>

<blockquote>
<p>This is equivelant to committing your NuGet <code>./packages</code> folder in .NET or your npm <code>./node_modules</code> folder in Node.</p>
</blockquote>

<p>I looked at many Go projects to find a solution I liked. There are a lot of approaches to this problem including <a href="https://code.google.com/p/go-wiki/wiki/PackageManagementTools">many attempts</a> at a package manager for Go. The community is <a href="https://groups.google.com/d/topic/golang-nuts/PLTY792AVzc/discussion">very much in flux</a> around this topic.</p>

<p>Personally, I felt any package manager tool was overkill for my needs. I was also discouraged by the fact that the community hasn&rsquo;t rallied behind any single package management solution.</p>

<p>In the end, this is my recipe for Go application structure.</p>

<ul>
<li>It uses all the standard <code>go get</code>, <code>go build</code>, and <code>go test</code> commands.</li>
<li>It doesn&rsquo;t involve copying your source code into a temporary folder during the build.</li>
<li>It doesn&rsquo;t require you to rewrite the import paths of third party packages.</li>
<li>It modifies your GOPATH environment variable in a very simple and isolated way. This is how we prioritize our <code>_vendor</code> directory so that third party packages are pulled from there instead of our primary GOPATH.</li>
<li>It wraps common commands in a Makefile. This can easily be replaced by a batch file on Windows or a <code>make.go</code> file that you can run with <code>go run make.go</code>.</li>
</ul>

<blockquote>
<p><a href="http://camlistore.org">Camlistore</a> uses the <code>make.go</code> approach (<a href="https://camlistore.googlesource.com/camlistore/+/master">see here</a>) and I really like its cross platform consistency. I may switch to it at some point.</p>
</blockquote>

<p><strong>Solution:</strong></p>

<p>For context, my system <code>GOPATH</code> is <code>~/mygo</code>.</p>

<p>My project is at <code>~/mygo/src/bitbucket.org/USERNAME/PROJECT</code>.</p>

<pre><code>~/mygo/src/bitbucket.org/USERNAME/PROJECT
|-- .gitignore
|-- README
|-- Makefile
|-- _vendor # Third party packages. This is a typical GOPATH workspace.
|   `-- src
|       `-- github.com
|           |-- codegangsta
|           |   |-- inject
|           |   `-- martini
|           `-- jpoehls
|               `-- gophermail
|-- bin  # My app's binary output.
|-- docs # My app's documentation.
`-- src  # My app's source code.
    |-- main_app
    |-- some_pkg
    `-- some_other_pkg
</code></pre>

<p>My Makefile looks like this:</p>

<pre><code>.PHONY: build doc fmt lint run test vendor_clean vendor_get vendor_update vet

# Prepend our _vendor directory to the system GOPATH
# so that import path resolution will prioritize
# our third party snapshots.
GOPATH := ${PWD}/_vendor:${GOPATH}
export GOPATH

default: build

build: vet
	go build -v -o ./bin/main_app ./src/main_app

doc:
	godoc -http=:6060 -index

# http://golang.org/cmd/go/#hdr-Run_gofmt_on_package_sources
fmt:
	go fmt ./src/...

# https://github.com/golang/lint
# go get github.com/golang/lint/golint
lint:
	golint ./src

run: build
	./bin/main_app

test:
	go test ./src/...

vendor_clean:
	rm -dRf ./_vendor/src

# We have to set GOPATH to just the _vendor
# directory to ensure that `go get` doesn't
# update packages in our primary GOPATH instead.
# This will happen if you already have the package
# installed in GOPATH since `go get` will use
# that existing location as the destination.
vendor_get: vendor_clean
	GOPATH=${PWD}/_vendor go get -d -u -v \
	github.com/jpoehls/gophermail \
	github.com/codegangsta/martini

vendor_update: vendor_get
	rm -rf `find ./_vendor/src -type d -name .git` \
	&amp;&amp; rm -rf `find ./_vendor/src -type d -name .hg` \
	&amp;&amp; rm -rf `find ./_vendor/src -type d -name .bzr` \
	&amp;&amp; rm -rf `find ./_vendor/src -type d -name .svn`

# http://godoc.org/code.google.com/p/go.tools/cmd/vet
# go get code.google.com/p/go.tools/cmd/vet
vet:
	go vet ./src/...
</code></pre>

<p><strong>Notes:</strong></p>

<ul>
<li>The standard <code>go get</code>, <code>go build</code>, and <code>go test</code> commands are used. All we do is prepend our <code>_vendor</code> workspace to the GOPATH to prioritize our snapshot of the third party packages during import path resolution.</li>
<li><code>vendor_update</code> task in the Makefile is a shotgun approach. It will update all of your dependencies to their latest version. 80% of the time this is what I want. In the 20% cases, I simply manually update the individual packages.</li>
<li>The <code>_vendor</code> directory can be called anything you like but the underscore prefix is important. The <a href="http://golang.org/cmd/go"><code>go</code></a> tool will ignore any files or directories that begin with <code>.</code> or <code>_</code> (<a href="http://golang.org/cmd/go/#hdr-Description_of_package_lists">read more</a>). This means we can run things like <code>go test</code> in our repo root without it picking up those third party packages.</li>
<li>I&rsquo;ve included some useful ancillary tasks as well. Such as the <a href="http://godoc.org/code.google.com/p/go.tools/cmd/godoc"><code>doc</code></a>, <a href="http://golang.org/cmd/go/#hdr-Run_gofmt_on_package_sources"><code>fmt</code></a>, <a href="https://github.com/golang/lint"><code>lint</code></a>, and <a href="http://godoc.org/code.google.com/p/go.tools/cmd/vet"><code>vet</code></a> tasks, and the fact that <code>build</code> runs <a href="http://godoc.org/code.google.com/p/go.tools/cmd/vet"><code>go vet</code></a> first.</li>
</ul>

<p><strong>How do you structure your Go projects?</strong> What does your build script look like? I&rsquo;m always interested in improving my methods, let me know what&rsquo;s working for you!</p>


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/2014/creating-an-ico-icon-file-for-your-windows-app/">Creating an ICO icon file for your Windows app</a>
            
        </h1>
        <p>
            <time datetime="2014-01-29 22:13:50 -0500 -0500" pubdate="pubdate">Wed, Jan 29, 2014</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/2014/creating-an-ico-icon-file-for-your-windows-app/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/2014/creating-an-ico-icon-file-for-your-windows-app/</span>
            </a>
        </p>
    </header>

    <p>Every Windows app needs an icon. Even yours.</p>

<p>If you are a developer then this task probably sounds simpler than it may turn out to be. First off, a lot of graphics programs (<a href="http://www.getpaint.net/">Paint.NET</a>, for example) don&rsquo;t support saving as an ICO file, the format needed by Windows.</p>

<p>Don&rsquo;t sweat. I&rsquo;ve got you covered. Here is the developer cheat sheet for creating an app icon file.</p>

<blockquote>
<p><strong>Pro tip:</strong> ICO files can contain <em>multiple</em> icons. Often they will contain multiple versions of the same icon in different sizes. For example, a 64px and a 16px icon, each optimized for their respective size.</p>

<p><a href="http://en.wikipedia.org/wiki/ICO_(file_format)">Wikipedia</a> has a lot more interesting info on the ICO format.</p>
</blockquote>

<ol>
<li>Create your icon. Make it square. Make it high res. Remember, you can always size down but it is harder to size up. I like to go with a minimum of 256px.</li>
<li>Export your icon to PNG files at multiple sizes. My minimum recommendation would be the following: 16px, 32px, 48px, 64px, 96px.</li>
<li>Use <a href="http://pnggauntlet.com/">PNGGauntlet</a> or <a href="http://advsys.net/ken/util/pngout.htm">PNGOut</a> to compress those PNGs. You won&rsquo;t lose quality but you will shed a lot of wasted bytes.<br/><img alt="Screenshot of PNGGauntlet" src="pnggauntlet.png" /></li>
<li>Use <a href="http://www.inedo.com/downloads/icon-maker">Icon Maker</a> to create your ICO file. Windows supports a single ICO file with multiple sizes embedded and that&rsquo;s what we want to do. Create a single ICO file with each of your specifically sized PNGs in it. You could also just drag in the largest PNG (96px for example) and trust Windows to resize it nicely.<br/><img alt="Screenshot of Icon Maker" src="iconmaker.png" /></li>
<li>Save out the ICO file and use it in your application.</li>
</ol>

<p>That&rsquo;s it! The biggest trick is knowing the tools. Icon Maker is a life saver. You should also understand what size icon(s) to use so that your app is well represented throughout the Windows UI. There is a <a href="http://stackoverflow.com/a/3244679/31308">good thread on StackOverflow</a> with more details on this.</p>

<p>I&rsquo;m not an expert in this area so I&rsquo;m sure there are things I&rsquo;m missing to further optimize your icon. Add any of your own tips in the comments!</p>


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/powershell-script-module-boilerplate/">PowerShell Script Module Boilerplate</a>
            
        </h1>
        <p>
            <time datetime="2013-12-21 10:43:31 -0600 CST" pubdate="pubdate">Sat, Dec 21, 2013</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/powershell-script-module-boilerplate/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/powershell-script-module-boilerplate/</span>
            </a>
        </p>
    </header>

    

<p>One of the things I always look for when getting familiar with a new language or environment is examples of the physical file structure and logical organization of the code. How do you layout your project files? What is idiomatic?</p>

<p>Unsurprisingly, this isn&rsquo;t always as simple as finding a few open-source projects on GitHub to reference. Believe it or not, there are a lot of pretty unorganized coders out there. I admit to being a bit OCD with my project structures. I like them clean, organized, and consistent.</p>

<p>In this post I&rsquo;m going to cover my preferred boilerplate for <a href="http://msdn.microsoft.com/en-us/library/dd878340(v=vs.85).aspx">PowerShell Script Modules</a>.</p>

<p>Script Modules are about as simple as it gets. Typically you have one or more PS1 or PSM1 files that contain your module&rsquo;s cmdlets. Beyond that you <em>should</em> have a <a href="http://msdn.microsoft.com/en-us/library/dd878337(v=vs.85).aspx">PSD1 manifest</a>.</p>

<h2 id="fork-this">Fork this!</h2>

<p>This entire boilerplate <a href="http://github.com/jpoehls/powershell-script-module-boilerplate">is on GitHub</a>. If you just want a solid starting point, download this repo. If you want to know more, keep reading.</p>

<h2 id="file-structure">File Structure</h2>

<pre><code>+- src/
| +- source_file.ps1
| +- ...
+- tools/
| +- release.ps1
+- LICENSE
+- README.md
</code></pre>

<ul>
<li><code>src/</code> contains the PS1, PSM1, PS1XML, and any other source files for the module.</li>
<li><code>tools/</code> is where I put any meta scripts for the project. Usually there is just one script here that builds a release version of my module.</li>
<li><code>LICENSE</code> - if your module is open-source, always specify what license you are releasing it under.</li>
<li><code>README.md</code> - always have a README file. Even if it is only a one sentence description. <a href="http://daringfireball.net/projects/markdown/">Markdown</a> is a great format to use for this.</li>
</ul>

<h2 id="explicit-exports">Explicit Exports</h2>

<p>By default, PowerShell will export all of the functions in your module. I recommend being explicit about this and always specifying which functions should be publically exported. This way it is easy to add private helper functions that are internal to your module without worrying about them being made public accidentally.</p>

<p>You do this by calling <a href="http://technet.microsoft.com/en-us/library/hh849736.aspx"><code>Export-ModuleMember</code></a> at the bottom of your source file. If you have a <code>source.psm1</code> file that contains a <code>Show-Calendar</code> function that should be public, you would do something like this:</p>

<pre><code># Show-Calendar.ps1
#
# Show-Calendar will be public.
# Any other functions in this file will be private.

function Show-Calendar {
    # ...
}

Export-ModuleMember -Function Show-Calendar
</code></pre>

<p><a href="http://msdn.microsoft.com/en-us/library/dd878340(v=vs.85).aspx">Full example &#8594;</a></p>

<h2 id="release-script">Release Script</h2>

<p><strong>Every project should have a release script.</strong> You should never be manually building your distributable release. At a minimum my release script will:</p>

<ol>
<li>Generate the PSD1 manifest for my module.</li>
<li>Save the manifest into a temporary <code>./dist</code> folder.</li>
<li>Copy all of the module source files into <code>./dist</code>.</li>
<li>Add all of the module&rsquo;s source files to a ZIP file ready for me to distribute.</li>
</ol>

<p>Here is what a simple <code>release.ps1</code> script might look like.</p>

<p><a href="https://github.com/jpoehls/powershell-script-module-boilerplate/blob/master/tools/release.ps1">View on GitHub &#8594;</a></p>

<pre><code>&lt;#
.SYNOPSIS
    Generates a manifest for the module
    and bundles all of the module source files
    and manifest into a distributable ZIP file.
#&gt;

[CmdletBinding()]
param(
    [Parameter(Mandatory = $true)]
    [version]$ModuleVersion
)

$ErrorActionPreference = &quot;Stop&quot;

Write-Host &quot;Building release for v$moduleVersion&quot;

$scriptPath = Split-Path -LiteralPath $(if ($PSVersionTable.PSVersion.Major -ge 3) { $PSCommandPath } else { &amp; { $MyInvocation.ScriptName } })

$src = (Join-Path (Split-Path $scriptPath) 'src')
$dist = (Join-Path (Split-Path $scriptPath) 'dist')
if (Test-Path $dist) {
    Remove-Item $dist -Force -Recurse
}
New-Item $dist -ItemType Directory | Out-Null

Write-Host &quot;Creating module manifest...&quot;

$manifestFileName = Join-Path $dist 'YourModule.psd1'

# TODO: Tweak the manifest to fit your module's needs.
New-ModuleManifest `
    -Path $manifestFileName `
    -ModuleVersion $ModuleVersion `
    -Guid fe524c79-95a6-4d02-8e15-30dddeb8c874 `
    -Author 'Your Name' `
    -CompanyName 'Your Company' `
    -Copyright '(c) $((Get-Date).Year) Your Company. All rights reserved.' `
    -Description 'Description of your module.' `
    -PowerShellVersion '3.0' `
    -DotNetFrameworkVersion '4.5' `
    -NestedModules (Get-ChildItem $src -Exclude *.psd1 | % { $_.Name })

Write-Host &quot;Creating release archive...&quot;

# Copy the distributable files to the dist folder.
Copy-Item -Path &quot;$src\*&quot; `
          -Destination $dist `
          -Recurse

# Requires .NET 4.5
[Reflection.Assembly]::LoadWithPartialName(&quot;System.IO.Compression.FileSystem&quot;) | Out-Null

$zipFileName = Join-Path ([System.IO.Path]::GetDirectoryName($dist)) &quot;$([System.IO.Path]::GetFileNameWithoutExtension($manifestFileName))-$ModuleVersion.zip&quot;

# Overwrite the ZIP if it already already exists.
if (Test-Path $zipFileName) {
    Remove-Item $zipFileName -Force
}

$compressionLevel = [System.IO.Compression.CompressionLevel]::Optimal
$includeBaseDirectory = $false
[System.IO.Compression.ZipFile]::CreateFromDirectory($dist, $zipFileName, $compressionLevel, $includeBaseDirectory)

Move-Item $zipFileName $dist -Force
</code></pre>

<h2 id="version-control">Version Control</h2>

<p>Always exclude your <code>./dist</code> folder from source control. As a rule of thumb, you never want to store the build output of any project in source control.</p>

<p>Depending on how you plan to release your module, you may prefer to exclude <code>*.psd1</code> manifest files from source control. This just keeps things clean and enforces that you use your release script to build the distributable.</p>

<h2 id="good-examples">Good Examples</h2>

<p>Here are a few open-source PowerShell modules that I&rsquo;ve found to be good examples to follow.</p>

<ul>
<li><a href="https://github.com/adamdriscoll/PoshInternals">PoshInternals</a> by Adam Driscoll</li>
<li><a href="https://github.com/psake/psake">Psake</a> by James Kovacs</li>
<li><a href="https://github.com/jpoehls/poshato">Poshato</a></li>
</ul>

<!--
## Binary Modules

I use a very similar file structure for [PowerShell Binary Modules][binary_module] but they do introduce more complexity into the release script. I'll be covering my binary module boilerplate in a future post. 
-->


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/powershell-batch-file-wrapper/">PowerShell Batch File Wrapper</a>
            
        </h1>
        <p>
            <time datetime="2013-12-18 10:43:31 -0600 CST" pubdate="pubdate">Wed, Dec 18, 2013</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/powershell-batch-file-wrapper/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/powershell-batch-file-wrapper/</span>
            </a>
        </p>
    </header>

    

<p>Sometimes you want a <code>.cmd</code> wrapper for your PowerShell script. Usually for me this is so people who aren&rsquo;t familiar with the command line can double-click to execute the script.</p>

<p>This batch file should be saved alongside your PowerShell script, like so.</p>

<pre><code>.\
 |- my_script.ps1
 |- my_script.cmd
</code></pre>

<p><code>my_script.cmd</code> will execute the same named <code>.ps1</code> file in the same directory, so <code>my_script.ps1</code> in this case. Any arguments passed to <code>my_script.cmd</code> will pass-through to the PowerShell script.</p>

<pre><code>@ECHO OFF

SET SCRIPTNAME=%~d0%~p0%~n0.ps1
SET ARGS=%*
IF [%ARGS%] NEQ [] GOTO ESCAPE_ARGS

:POWERSHELL
PowerShell.exe -NoProfile -NonInteractive -NoLogo -ExecutionPolicy Unrestricted -Command &quot;&amp; { $ErrorActionPreference = 'Stop'; &amp; '%SCRIPTNAME%' @args; EXIT $LASTEXITCODE }&quot; %ARGS%
EXIT /B %ERRORLEVEL%

:ESCAPE_ARGS
SET ARGS=%ARGS:&quot;=\&quot;%
SET ARGS=%ARGS:`=``%
SET ARGS=%ARGS:'=`'%
SET ARGS=%ARGS:$=`$%
SET ARGS=%ARGS:{=`}%
SET ARGS=%ARGS:}=`}%
SET ARGS=%ARGS:(=`(%
SET ARGS=%ARGS:)=`)%
SET ARGS=%ARGS:,=`,%
SET ARGS=%ARGS:^%=%

GOTO POWERSHELL
</code></pre>

<h2 id="what-s-going-on-here">What&rsquo;s going on here?</h2>

<ul>
<li><code>%SCRIPTNAME%</code> variable holds the name of the PowerShell script to execute. <code>%~d0%~p0%~n0</code> magic gets the full path of the
current batch script without the file extension. By specifying the full path of the PowerShell script
like this we can guarantee that it is always executed from the right place
no matter what your working directory is.</li>
<li>Escapes special characters in the arguments so that they are passed to PowerShell as you would expect.</li>
<li>Runs <code>PowerShell.exe</code> with:

<ul>
<li><code>-NoProfile</code> to improve startup performance. Scripts you are distributing
shouldn&rsquo;t rely on anything in your profile anyway.</li>
<li><code>-NonInteractive</code> because usually my scripts don&rsquo;t need input from the user.</li>
<li><code>-ExecutionPolicy Unrestricted</code> to ensure that the PowerShell script can
be executed regardless of the machine&rsquo;s default Execution Policy.</li>
<li><code>-Command</code> syntax for executing the command ensures that PowerShell
returns the correct exit code from your script.
Using <code>-Command</code> with <code>$ErrorActionPreference = 'Stop'</code> also ensures that
errors thrown from your script cause PowerShell.exe to return a failing
exit code (1). <a href="/2012/powershell-batch-files-exit-codes/">PowerShell is quite buggy when it comes to bubbling exit
codes.</a>
This is the safest method I&rsquo;ve found.</li>
</ul></li>
</ul>

<h2 id="batch-file-tips">Batch file tips</h2>

<h3 id="special-characters-in-arguments">Special characters in arguments</h3>

<p>Remember that certain special characters need to be escaped in arguments passed to the batch file. These characters are: <code>^  &amp;  &lt;  &gt;  /?</code>. Note that <code>/?</code> is a sequence and is recognized as a help flag when passed to a batch file.</p>

<blockquote>
<p><code>my_script.cmd &quot;I &quot;&quot;am&quot;&quot; quoted&quot;</code> passes a single argument <code>I &quot;am&quot; quoted</code> to PowerShell.</p>

<p><code>my_script.cmd &quot;^&amp;&lt;&gt;/?&quot;</code> passes <code>^&amp;&lt;&gt;/?</code></p>
</blockquote>

<h3 id="environment-variable-expansion">Environment variable expansion</h3>

<p>Environment variables get automatically expanded in batch file arguments.</p>

<blockquote>
<p><code>my_script.cmd %PROGRAMFILES%</code> passes <code>C:\Program Files</code></p>
</blockquote>


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="http://joshua.poehls.me/2012/killing-processes-in-disconnected-terminal-service-sessions/">Killing Processes In Disconnected Terminal Service Sessions</a>
            
        </h1>
        <p>
            <time datetime="2012-12-12 00:00:00 &#43;0000 UTC" pubdate="pubdate">Wed, Dec 12, 2012</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="http://joshua.poehls.me/2012/killing-processes-in-disconnected-terminal-service-sessions/">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://joshua.poehls.me/2012/killing-processes-in-disconnected-terminal-service-sessions/</span>
            </a>
        </p>
    </header>

    <p>Usually it is best to configure your terminal service policy to log out disconnected sessions, however there may be cases where you only want to kill specific applications when the user disconnects.</p>

<p>This is easy to do with a PowerShell script that you run periodically as a scheduled task. The processes won&rsquo;t be killed <em>immediately</em> when the user disconnects but will be killed shortly after.</p>

<p>This script will, by default, only kill the OUTLOOK processes in disconnected sessions after waiting 15 seconds for it to gracefully close. It is trivial to tweak the script to kill whichever processes you care about.</p>

<pre><code># kill-processes.ps1

# This script supports being run with -WhatIf and -Confirm parameters.
[CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact='Medium')]
param (
    # Regex of the states that should be included in the process killing field.
    [string]$IncludeStates = '^(Disc)$', # Only DISCONNECTED sessions by default.
    # Regex of the processes to kill
    [string]$KillProcesses = '^(OUTLOOK)$', # Only OUTLOOK by default.
    [int]$GracefulTimeout = 15 # Number of seconds to wait for a graceful shutdown before forcefully closing the program.
)

function Get-Sessions
{
    # `query session` is the same as `qwinsta`

    # `query session`: http://technet.microsoft.com/en-us/library/cc785434(v=ws.10).aspx

    # Possible session states:
    &lt;#
    http://support.microsoft.com/kb/186592
    Active. The session is connected and active.
    Conn.   The session is connected. No user is logged on.
    ConnQ.  The session is in the process of connecting. If this state
            continues, it indicates a problem with the connection.
    Shadow. The session is shadowing another session.
    Listen. The session is ready to accept a client connection.
    Disc.   The session is disconnected.
    Idle.   The session is initialized.
    Down.   The session is down, indicating the session failed to initialize correctly.
    Init.   The session is initializing.
    #&gt;

    # Snippet from http://poshcode.org/3062
    # Parses the output of `qwinsta` into PowerShell objects.
    $c = query session 2&gt;&amp;1 | where {$_.gettype().equals([string]) }

    $starters = New-Object psobject -Property @{&quot;SessionName&quot; = 0; &quot;Username&quot; = 0; &quot;ID&quot; = 0; &quot;State&quot; = 0; &quot;Type&quot; = 0; &quot;Device&quot; = 0;};
     
    foreach($line in $c) {
         try {
             if($line.trim().substring(0, $line.trim().indexof(&quot; &quot;)) -eq &quot;SESSIONNAME&quot;) {
                $starters.Username = $line.indexof(&quot;USERNAME&quot;);
                $starters.ID = $line.indexof(&quot;ID&quot;);
                $starters.State = $line.indexof(&quot;STATE&quot;);
                $starters.Type = $line.indexof(&quot;TYPE&quot;);
                $starters.Device = $line.indexof(&quot;DEVICE&quot;);
                continue;
            }
           
            New-Object psobject -Property @{
                &quot;SessionName&quot; = $line.trim().substring(0, $line.trim().indexof(&quot; &quot;)).trim(&quot;&gt;&quot;)
                ;&quot;Username&quot; = $line.Substring($starters.Username, $line.IndexOf(&quot; &quot;, $starters.Username) - $starters.Username)
                ;&quot;ID&quot; = $line.Substring($line.IndexOf(&quot; &quot;, $starters.Username), $starters.ID - $line.IndexOf(&quot; &quot;, $starters.Username) + 2).trim()
                ;&quot;State&quot; = $line.Substring($starters.State, $line.IndexOf(&quot; &quot;, $starters.State)-$starters.State).trim()
                ;&quot;Type&quot; = $line.Substring($starters.Type, $starters.Device - $starters.Type).trim()
                ;&quot;Device&quot; = $line.Substring($starters.Device).trim()
            }
        } catch {
            throw $_;
            #$e = $_;
            #Write-Error -Exception $e.Exception -Message $e.PSMessageDetails;
        }
    }
}

# Helper function for getting the singular or plural form of
# a word based on the given count.
# Because we want proper log messages.
function Get-ProperWord([string]$singularWord, [int]$count) {
    if ($count -eq 0 -or $count -gt 1) {
        if ($singularWord.EndsWith(&quot;s&quot;)) {
            return &quot;$($singularWord)es&quot;;
        }
        else {
            return &quot;$($singularWord)s&quot;;
        }
    }
    else {
        return $singularWord;
    }
}

# Get a list of all terminal sessions that are in the state we care about.
$IncludedSessions = Get-Sessions `
                        | Where { $_.State -match $IncludeStates } `
                        | Select -ExpandProperty ID

# Get a list of all processes in one of those terminal sessions
# that match a process we want to kill.
$SessionProcesses = $IncludedSessions `
    | % { $id = $_;
          Get-Process `
            | Where { $_.SessionID -eq $id -and $_.Name -match $KillProcesses } }

# Get some words to use in log output.
$wordSecond = $(Get-ProperWord 'second' $GracefulTimeout)
$wordProcess = $(Get-ProperWord 'process' $SessionProcesses.Length)

if ($SessionProcesses.Length -gt 0) {
    # Initiate a graceful shutdown of the processes.
    # http://powershell.com/cs/blogs/tips/archive/2010/05/27/stopping-programs-gracefully.aspx
    Write-Output &quot;Gracefully closing $($SessionProcesses.Length) $wordProcess&quot;
    $SessionProcesses `
        | % { if ($PSCmdlet.ShouldProcess(&quot;$($_.Name) ($($_.Id))&quot;, &quot;CloseMainWindow&quot;)) { $_.CloseMainWindow() } } `
        | Out-Null

    # Wait X seconds for the programs to close gracefully.
    Write-Output &quot;Waiting $GracefulTimeout $wordSecond for the $wordProcess to close&quot;
    if ($GracefulTimeout -gt 0) {
        if ($PSCmdlet.ShouldProcess(&quot;Current Process&quot;, &quot;Start-Sleep&quot;)) {
            Start-Sleep -Seconds $GracefulTimeout
        }
    }

    # Force any remaining processes to close, the hard way.
    Write-Output &quot;Forcefully closing any remaining processes&quot;
    $SessionProcesses `
        | Where { $_.HasExited -ne $true } `
        | Stop-Process -ErrorAction SilentlyContinue
}
else {
    Write-Output &quot;No processes to close&quot;
}
</code></pre>


</article>

<div class="fin symbol">&#10687;</div>

</div>
</div>
	
	</section>

</div>

<nav class="pagination">

	<a href="/page/4/" aria-label="Earlier Posts"><span aria-hidden="true">&laquo; Earlier Posts</span></a>


	
		&nbsp;&nbsp;
	


	<a href="/page/2/" aria-label="Recent Posts"><span aria-hidden="true">Recent Posts &raquo;</span></a>

</nav>

<footer>
<p>Subscribe to the <a href="/feed.xml">feed</a> to stay up-to-date.</p>
<p>Browse the <a href="/archives">archives</a> if you're bored.</p>
<p>&copy;&nbsp;2014&ndash;2019&nbsp;Joshua&nbsp;Poehls.</p>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55160531-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>