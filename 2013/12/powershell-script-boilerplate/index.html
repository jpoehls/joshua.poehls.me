<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8">
<title>joshua poehls | silent thought</title>

<link rel="canonical" href="http://localhost:1313/2013/12/powershell-script-boilerplate">
<link href="/feed.xml" rel="alternate" type="application/atom+xml" title="joshua poehls | silent thought">
<meta name="generator" content="Hugo 0.13" />


<link rel="stylesheet" href="/normalize.css">
<link rel="stylesheet" href="/skeleton.css">
<link rel="stylesheet" href="/styles.css">


<link href='http://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>


<meta name="viewport" content="width=device-width, initial-scale=1">


<link rel="apple-touch-icon" href="/touch-icon-iphone.png" /> 
<link rel="apple-touch-icon" sizes="76x76" href="/touch-icon-ipad.png" /> 
<link rel="apple-touch-icon" sizes="120x120" href="/touch-icon-iphone-retina.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/touch-icon-ipad-retina.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/touch-icon-iphone-retinahd.png">

</head>
<body lang="en-US">

<header id="masthead">
	<div class="container">
		<div class="row">
			<div class="twelve columns">
				<h1>
					<small>I am</small>
					<a href="/">Joshua Poehls</a>.
					<small class="contact-link"><a href="/contact">Say hello</a></small>
					<small class="archives-link"><a href="/archives">Archives</a></small>
					<span class="aka">(not so) silent thoughts</span>
				</h1>
			</div>
		</div>
	</div>
</header>



<div class="container">

	

	<section id="posts">
	<div class="row">
<div class="twelve columns">

<article class="post">
    <header>
        <h1>
            
            <a href="/2013/12/powershell-script-boilerplate">PowerShell Script Boilerplate</a>
            
        </h1>
        <p>
            <time datetime="2013-12-18 10:43:31 -0600 CST" pubdate="pubdate">Wed, Dec 18, 2013</time>
            <span class="symbol">&#8226;</span>
            <a class="permalink" title="Permalink" href="/2013/12/powershell-script-boilerplate">
                <span class="noprint symbol">&#8734;</span>
                <span class="printonly">http://localhost:1313/2013/12/powershell-script-boilerplate</span>
            </a>
        </p>
    </header>

    

<p>This post is as much for me as it is for you, my reader. I write a lot of
PowerShell scripts and they tend to follow a certain pattern. This is my
personal boilerplate for PowerShell scripts. Maybe it can help you as well.</p>

<h2 id="powershell-script:469e3590a69ce674428532a2149fa57a">PowerShell Script</h2>

<pre><code>$ErrorActionPreference = &quot;Stop&quot;

$scriptPath = Split-Path -LiteralPath $(if ($PSVersionTable.PSVersion.Major -ge 3) { $PSCommandPath } else { &amp; { $MyInvocation.ScriptName } })

$stopwatch = [System.Diagnostics.Stopwatch]::StartNew()

try
{
    # TODO: Insert script here...
}
finally
{
    Write-Host &quot;Done!&quot;
    Write-Host &quot;Time to complete: $($stopwatch.Elapsed)&quot;
}
</code></pre>

<h3 id="highlights:469e3590a69ce674428532a2149fa57a">Highlights</h3>

<ul>
<li>Sets <code>$ErrorActionPreference</code> so that unhandled exceptions will halt
the script execution. By default, PowerShell will roll on when an exceptions
is thrown and this statement makes my scripts safe by default.</li>
<li>Set <code>$scriptPath</code> to the directory path of the current script.
Note that this is different than the working directory.</li>
<li>Most of the time I want to know how long my script takes to run so I include
a <code>$stopwatch</code> that will always output the elapsed time when the script finishes.</li>
</ul>

<p><a id="bat-wrapper"> </a></p>

<h2 id="batch-file-wrapper:469e3590a69ce674428532a2149fa57a">Batch File Wrapper</h2>

<p>PowerShell is still kind of a different beast so I usually like to include a
batch file wrapper for PowerShell scripts that I will be distributing or
that are shared with my team.</p>

<pre>
@ECHO OFF

SET SCRIPTPATH=%~d0%~p0boilerplate-script.ps1

SET ARGS=%*
IF [%ARGS%] NEQ [] GOTO ESCAPE_ARGS

:POWERSHELL
PowerShell.exe -NoProfile -NonInteractive -NoLogo -ExecutionPolicy Unrestricted -Command "&amp; { $ErrorActionPreference = 'Stop'; &amp; '%SCRIPTPATH%' @args; EXIT $LASTEXITCODE }" %ARGS%
EXIT /B %ERRORLEVEL%

:ESCAPE_ARGS
SET ARGS=%ARGS:"=\"%
SET ARGS=%ARGS:`=``%
SET ARGS=%ARGS:'=`'%
SET ARGS=%ARGS:$=`$%
SET ARGS=%ARGS:&#123;=`&#123;%
SET ARGS=%ARGS:}=`}%
SET ARGS=%ARGS:(=`(%
SET ARGS=%ARGS:)=`)%
SET ARGS=%ARGS:,=`,%
SET ARGS=%ARGS:^%=%

GOTO POWERSHELL
</pre>

<h3 id="highlights-1:469e3590a69ce674428532a2149fa57a">Highlights</h3>

<ul>
<li>Stores the full path of the PowerShell script we want to execute in the
<code>%SCRIPTPATH%</code> variable. <code>%d0%~p0</code> magic gets the directory path of the
current batch script. By specifying the full path of the PowerShell script
like this we can guarantee that it is always executed from the right place
no matter what your working directory is.</li>
<li>Escapes special characters in the arguments so that they are passed to PowerShell
as you would expect.</li>
<li>Runs <code>PowerShell.exe</code> with:

<ul>
<li><code>-NoProfile</code> to improve startup performance. Scripts you are distributing
shouldn&rsquo;t rely on anything in your profile anyway.</li>
<li><code>-NonInteractive</code> because usually my scripts don&rsquo;t need input from the user.</li>
<li><code>-ExecutionPolicy Unrestricted</code> to ensure that the PowerShell script can
be executed regardless of the machine&rsquo;s default Execution Policy.</li>
<li><code>-Command</code> syntax for executing the command ensures that PowerShell
returns the correct exit code from your script.
Using <code>-Command</code> with <code>$ErrorActionPreference = 'Stop'</code> also ensures that
errors thrown from your script cause PowerShell.exe to return a failing
exit code (1). <a href="{{site.url}}/2012/powershell-batch-files-exit-codes/">PowerShell is quite buggy when it comes to bubbling exit
codes.</a>
This is the safest method I&rsquo;ve found.</li>
</ul></li>
</ul>

<h3 id="escaping-special-characters:469e3590a69ce674428532a2149fa57a">Escaping Special Characters</h3>

<p>Some characters still need to be surrounded by double quotes
when passing them to the batch file. They have specifial signifiance to batch
files. These characters are: <code>^  &amp;  &lt;  &gt;  /?</code>.
Note that <code>/?</code> is a sequence and is recognized as a help flag when passed to
a batch file.</p>

<blockquote>
<p><code>boiler.cmd &quot;I &quot;&quot;am&quot;&quot; quoted&quot;</code> passes a single argument <code>I &quot;am&quot; quoted</code> to PowerShell.</p>

<p><code>boiler.cmd &quot;^&amp;&lt;&gt;/?&quot;</code> passes <code>^&amp;&lt;&gt;/?</code></p>
</blockquote>

<p>There is one problem I haven&rsquo;t solved yet. Passing an environment variable as an argument
to the batch file will expand it when passed to PowerShell. I don&rsquo;t know how to avoid this.</p>

<blockquote>
<p><code>boiler.cmd %CD%</code> passes <code>c:\...</code></p>

<p><code>boiler.cmd ^%CD^%</code> passes <code>%CD%</code></p>

<p><code>boiler.cmd &quot;%CD%&quot;</code> passes <code>c:\...</code></p>
</blockquote>

<p>The last example is the case I don&rsquo;t know how to avoid.</p>

<p>Do you have a boilerplate for scripts that you write? What do you include in yours? Let me know in the comments!</p>

<p>{{site.powershell_book_ad}}</p>


</article>

<div class="fin">&#10687;</div>

</div>
</div>
	</section>

	

</div>

<footer>
<p>Subscribe to the <a href="/feed.xml">feed</a> to stay up-to-date.</p>
<p>Browse the <a href="/archives">archives</a> if you're bored.</p>
<p>&copy;&nbsp;2014-2015&nbsp;Joshua&nbsp;Poehls.</p>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55160531-2', 'auto');
  ga('send', 'pageview');

</script>
<script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>